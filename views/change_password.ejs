<!DOCTYPE html>
<html lang="en">

<head>
    <title>Webrtc Login</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Favicon icon -->
    <link rel="icon" href="assets1/images/favicon.ico" type="image/x-icon">
    <!-- fontawesome icon -->
    <link rel="stylesheet" href="assets1/fonts/fontawesome/css/fontawesome-all.min.css">
    <!-- animation css -->
    <link rel="stylesheet" href="assets1/plugins/animation/css/animate.min.css">
    <!-- vendor css -->
    <link rel="stylesheet" href="assets1/css/style.css">
    <!-- Alertify Css code -->
    <link rel="stylesheet" href="assets/alertify/alertify.core.css?v=5.17.1" />
    <link rel="stylesheet" href="assets/alertify/alertify.default.css?v=5.17.1" />
    <link rel="stylesheet" href="assets/alertify/toastr.css?v=5.17.1" type="text/css" />
    <link rel="stylesheet" href="alertify.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/sweetalert2@11'></script>
    <!-- Alertify Javascript code -->
    <script src="assets/alertify/alertify.min.js?v=5.17.1"></script>
    <script src="assets/alertify/modernizr.js?v=5.17.1"></script>
    <script src="assets/alertify/toastr.js?v=5.17.1"></script>
    <script src="assets/sipjs/include.js?v=5.17.1" type="text/javascript"> </script>
    <script type="text/javascript" src="assets/sipjs/all_constant.js?v=5.17.1"></script>
    <script type="text/javascript" src="assets/sipjs/custom.js?v=5.17.1"></script>
    <script type="text/javascript" src="assets/sipjs/custom_new.js?v=5.17.1"></script>

    <div id="toasts"></div>
    <style>
        .full_width {
            width: 100% !important;
        }

        #succes_msg {
            display: none;
        }

        /* #error_msg {
            display: none;
        } */
    </style>


</head>

<body>


    <div id="toasts"></div>
    <div class="auth-wrapper">
        <div class="auth-content">
            <div class="auth-bg">
                <span class="r"></span>
                <span class="r s"></span>
                <span class="r s"></span>
                <span class="r"></span>
            </div>
            <div class="card">
                <div class="card-body text-center">
                    <div class="mb-4">
                        <i class="feather icon-unlock auth-icon"></i>
                    </div>
                    <h3 class="mb-4">Change Password</h3>
                    <form id="changePasswordForm" method="post" action="/change_User_Password" name="validate_user">
                        <div>
                            <b class="text-success" id="succes_msg"></b>
                            <b class="text-danger" id="error_msg">
                                <%= typeof msg !=='undefined' ? msg : '' %>
                            </b>
                        </div>
                        <div class="input-group mb-3">
                            <input type="hidden" name="user_id" id="user_id">
                        </div>
                        <div class="input-group mb-4">
                            <input type="password" name="new_password" id="new_password" class="form-control full_width"
                                placeholder="New Password">
                            <span id="toggleNewPassword" class="position-absolute"
                                style="right: 10px; top: 10px; cursor: pointer;">
                                <i class="fas fa-eye"></i>
                            </span>
                            <span style="color:red; font-weight:normal; font-size:12px;" id="err_new_password"></span>
                        </div>
                        <div class="input-group mb-4">
                            <input type="password" name="confirm_password" id="confirm_password"
                                class="form-control full_width" placeholder="Confirm Password">
                            <span id="toggleConfirmPassword" class="position-absolute"
                                style="right: 10px; top: 10px; cursor: pointer;">
                                <i class="fas fa-eye"></i>
                            </span>
                            <span style="color:red; font-weight:normal; font-size:9px;"
                                id="err_confirm_password"></span>
                        </div>
                        <button type="submit" class="btn btn-primary shadow-2 mb-4" id="change_password">Change
                            Password</button>
                    </form>
                    <div>
                        <img src="assets1/images/galaxypro.png">
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Required Js -->
    <script src="assets1/js/vendor-all.min.js"></script>
    <script src="assets1/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="alertify.js"></script>
    
    <script>
        
        document.getElementById("toggleConfirmPassword").addEventListener("click", function () {
            const passwordField = document.getElementById("confirm_password");
            const icon = this.querySelector("i");

            // Toggle the password field type
            if (passwordField.type === "password") {
                passwordField.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                passwordField.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        });
    </script>

    <script>
        document.getElementById('changePasswordForm').addEventListener('submit', function (event) {

            event.preventDefault(); // Prevent form submission

            // Clear previous error messages
            document.getElementById('err_new_password').textContent = '';
            document.getElementById('err_confirm_password').textContent = '';
            document.getElementById('error_msg').textContent = '';  // Clear the general error message
            $("#error_msg").css("display", "none");

             // Get field values
                const userId = document.getElementById('user_id').value.trim();
            // Get field values
            const newPassword = document.getElementById('new_password').value.trim();
            const confirmPassword = document.getElementById('confirm_password').value.trim();

            let hasError = false;
            let oldPassword = '<%= session.password  %>';

            // Validate new password
            if (!newPassword) {
                document.getElementById('err_new_password').textContent = 'New password is required.';
                hasError = true;
            } else if (newPassword.length < 8 || newPassword.length > 20) {
                console.log("New password must be  8  to 20 characters .");
                document.getElementById('err_new_password').textContent = 'New password must be 8 to 20 characters .';
                hasError = true;
            }else if (oldPassword === newPassword) {
                console.log("New password must be different from the old password");
                document.getElementById('err_new_password').textContent = "New password must be different from the old password";
                hasError = true;
            }

            // Validate confirm password
            if (!confirmPassword) {
                document.getElementById('err_confirm_password').textContent = 'Confirm password is required.';
                hasError = true;
            } else if (newPassword !== confirmPassword) {
                document.getElementById('err_confirm_password').textContent = 'Passwords do not match.';
                hasError = true;
            }

            // If no client-side validation errors, send the form data to the server
            if (!hasError) {
                const submitButton = $("#change_password");
                submitButton.prop("disabled", true);
                let id=localStorage.getItem("User_Status_ID");
                const jsonData = {
                        user_id: userId,
                        new_password: newPassword,
                        confirm_password: confirmPassword,
                        id:id

                    };
                    console.log("jSONdATA=>",jsonData);
                    
                // Use fetch to submit the form data
                fetch('/change_User_Password', {
                    method: 'POST',
                    headers: {
                            'Content-Type': 'application/json' // Change the Content-Type to application/json
                        },
                    body: JSON.stringify(jsonData)
                })
                    .then(response => response.json())  // Assuming the server responds with JSON
                    .then(data => {
                        // If the response contains errors from the server
                        console.log("data responce ", data);
                        if (data.error) {
                            // document.getElementById('error_msg').textContent = data.error;
                            $("#error_msg").text( data.error).css("display", "block");
                            document.getElementById('succes_msg').textContent = '';  // Clear success message
                            submitButton.prop("disabled", false);  
                        } else {
                            // Handle success response
                            $("#succes_msg").text("Password changed successfully!").css("display", "block");
                            // document.getElementById('succes_msg').textContent = data.message || 'Password changed successfully!';
                            document.getElementById('error_msg').textContent = '';  // Clear error messages
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 500);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('error_msg').textContent = 'An error occurred while changing the password.';
                        document.getElementById('succes_msg').textContent = '';  // Clear success message
                    });
            }
        });



        document.getElementById("toggleNewPassword").addEventListener("click", function () {
            const passwordField = document.getElementById("new_password");
            const icon = this.querySelector("i");

            // Toggle the password field type
            if (passwordField.type === "password") {
                passwordField.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                passwordField.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        });
    </script>
</body>
</html>